<!DOCTYPE html>
<html lang="zh-cn">
<script>
    var url = decodeURI(window.location.href);
</script>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歌曲</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.8.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="topbar">
        <div class="powered">
            Powered By
            <a href="http://www.kugou.com/?targetat=Fh音乐" target="_blank" rel="noopener noreferrer">酷狗音乐</a>
        </div>
    </div>
    <div class="body">
        <div class="box">
            <div class="search">
                <input type="text" id='search_input'><button id='search_start' class='bi bi-search'></button>
            </div>
            <div class="bg">
                <div class="left">
                    <img src="" alt="1234" class="img_bg">
                    <div class="download bi bi-download" onclick='download();'>下载这首音乐</div>
                </div>
                <div class="right">
                    <h1 class="title"></h1>
                    <div class="message">
                        <p class="singer">歌手：<span></span></p>
                        <p class="zhuanj">专辑：<span></span></p>
                    </div>
                    <div class="gclist">
                        <ul></ul>
                    </div>
                    <div class="downmini bi bi-download" onclick='download();'></div>
                </div>
            </div>
            <div class="bar">
                <img src="" alt="1234" class="img_bg">
                <div class="cz">
                    <input type="range" name="" id="timerange" min='0' max='100' value="0">
                    <div class="czs">
                        <div class="toggleplay bi bi-pause"></div>
                        <div class="time"><span class="z">00:00</span>/<span class="s">00:00</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer">
        <div class="left">
            <a href="docs/yhxy.html" target="_blank" rel="noopener noreferrer">用户协议</a>
            <a href="docs/ystk.html" target="_blank" rel="noopener noreferrer">隐私条款</a>
            <a href="docs/gywm.html" target="_blank" rel="noopener noreferrer">关于我们</a>
        </div>
        <div class="right">
            本站已稳定运行 -1 天
        </div>
    </div>
    <audio src="" autoplay id='audio'></audio>
    <a href=""></a>
</body>
<script>
    var aaa = document.querySelectorAll('a');
    aaa[aaa.length - 1].remove();
    document.getElementById('search_start').onclick = function() {
        var a = document.getElementById('search_input').value;
        if (a) {
            window.open('search.html?s=' + a);
        }
    };
    fn();
    var oLRC = {
        ti: "", //&#27468;&#26354;&#21517;
        ar: "", //&#28436;&#21809;&#32773;
        al: "", //&#19987;&#36753;&#21517;
        by: "", //&#27468;&#35789;&#21046;&#20316;&#20154;
        offset: 0, //&#26102;&#38388;&#34917;&#20607;&#20540;&#65292;&#21333;&#20301;&#27627;&#31186;&#65292;&#29992;&#20110;&#35843;&#25972;&#27468;&#35789;&#25972;&#20307;&#20301;&#32622;
        ms: [] //&#27468;&#35789;&#25968;&#32452;{t:&#26102;&#38388;,c:&#27468;&#35789;}
    };
    var ys = 73;
    var nowc = 0;

    function fn() {
        var url = window.location.href;
        if (url.indexOf('?hash=') == -1) {
            window.location.href = 'index.html';
        }
        var hash;
        var auldm;
        if (url.indexOf('?hash=') != -1) {
            hash = url.substring(url.indexOf('?hash=') + 6, url.indexOf('&'))
        };
        if (url.indexOf('&album_id=') != -1) {
            auldm = url.substring(url.indexOf('&album_id=') + 10, url.length);
        };
        // console.log(hash, auldm, url.indexOf('&author_id='), url.substring(url.indexOf('&author_id=') + 11, url.length), url.indexOf('&author='));
        var longtime = new Date().getTime();
        var script = document.createElement('script');
        script.src = `https://wwwapi.kugou.com/yy/index.php?r=play/getdata&callback=getData&hash=${hash}&dfid=3x7tnx0ml6Ty0CA2IZ4TPrkU&appid=1014&mid=04f5284cfe29a3cf5bc2b7a66a75f5c9&platid=4&album_id=${auldm}&_=${longtime}`;
        document.querySelector('body').append(script);

    }

    function getData(a) {
        console.log(a);
        $('#audio').attr('src', a.data.play_url);
        $('.bg .right h1.title').html(a.data.song_name);
        $('.bg .right .message .zhuanj span').append(a.data.album_name);
        var author_b = '';
        for (var i = 0; i < a.data.authors.length; i++) {
            if (i == a.data.authors.length - 1) {
                author_b += a.data.authors[i].author_name
            } else {
                author_b += a.data.authors[i].author_name + '&#12289;';
            }
        }
        $('.bg .right .message .singer span').append(author_b);
        $('.img_bg').attr('src', a.data.img);
        createLrcObj(a.data.lyrics);
        console.log(oLRC);
        for (var i = 0; i < oLRC.ms.length; i++) {
            $('.bg .right .gclist ul').append('<li>' + oLRC.ms[i].c + '</li>')
        }
        $('.bg .right .gclist ul li').eq(0).addClass('onc');


    }

    function download() {
        window.open($('#audio').attr('src'));
    }
    $('.toggleplay').click(function() {
        var isplay = !document.getElementById('audio').paused;
        if (isplay) {
            audio.pause();
            $(this).addClass('bi-play');
            $(this).removeClass('bi-pause');
        } else {
            $(this).removeClass('bi-play');
            $(this).addClass('bi-pause');
            audio.play();
        }
    });
    updateTime();

    function updateTime() {
        setTimeout(() => {
            var time = parseInt(audio.currentTime);
            var stime = queryTime(time);
            var mstime = audio.currentTime;
            $('div.time span.z').html(stime);
            $('#timerange').val(time / audio.duration * 100);
            var nowa = 0;
            for (var i = 0; i < oLRC.ms.length; i++) {
                try {
                    if (parseFloat(oLRC.ms[i].t) <= mstime && parseFloat(oLRC.ms[i + 1].t) > mstime) {
                        nowa = i;
                        break;
                    }
                } catch (error) {
                    if (parseFloat(oLRC.ms[i].t) <= mstime) {
                        nowa = i;
                        break;
                    }
                }
            }
            nowc = nowa;
            var pds = ys - nowc * 41;
            $('.bg .right .gclist ul li').removeClass('onc');
            $('.bg .right .gclist ul li').eq(nowc).addClass('onc');
            $('.bg .right .gclist ul li').css({
                'top': pds + 'px'
            });
            updateTime();
        }, 1000);
    }

    function queryTime(a) {
        var s = parseInt(a % 60);
        m = parseInt(a / 60);
        if (s < 10) {
            s = '0' + s;
        };
        if (m < 10) {
            m = '0' + m;
        }
        return m + ':' + s;
    }
    var audio = document.getElementById('audio');

    audio.oncanplay = function() {
        a = queryTime(audio.duration);
        $('div.time span.s').html(a);
    }
    $('#timerange').change(function() {
        audio.currentTime = ($(this).val() / 100) * document.getElementById('audio').duration;
    });
    audio.onended = function() {
        $('.toggleplay').removeClass('bi-pause');
        $('.toggleplay').addClass('bi-play');
        audio.currentTime = 0;
    }


    function createLrcObj(lrc) {
        if (lrc.length == 0) return;
        var lrcs = lrc.split('\n');
        for (var i in lrcs) {
            lrcs[i] = lrcs[i].replace(/(^\s*)|(\s*$)/g, "");
            var t = lrcs[i].substring(lrcs[i].indexOf("[") + 1, lrcs[i].indexOf("]"));
            var s = t.split(":");
            if (isNaN(parseInt(s[0]))) {
                for (var i in oLRC) {
                    if (i != "ms" && i == s[0].toLowerCase()) {
                        oLRC[i] = s[1];
                    }
                }
            } else { //&#26159;&#25968;&#20540;
                var arr = lrcs[i].match(/\[(\d+:.+?)\]/g);
                var start = 0;
                for (var k in arr) {
                    start += arr[k].length;
                }
                var content = lrcs[i].substring(start);
                for (var k in arr) {
                    var t = arr[k].substring(1, arr[k].length - 1);
                    var s = t.split(":");
                    oLRC.ms.push({
                        t: (parseFloat(s[0]) * 60 + parseFloat(s[1])).toFixed(3),
                        c: content
                    });
                }
            }
        }
        oLRC.ms.sort(function(a, b) { //&#25353;&#26102;&#38388;&#39034;&#24207;&#25490;&#24207;
            return a.t - b.t;
        });
        /*
        for(var i in oLRC){ //&#26597;&#30475;&#35299;&#26512;&#32467;&#26524;
            console.log(i,":",oLRC[i]);
        }*/
    }
</script>

</html>
